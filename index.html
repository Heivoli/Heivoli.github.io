<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HN</title>

  <style>
    :root{ --bg:#000; --panel:#000; --border:#222; --text:#ddd; --muted:#777; --accent:#1f8cff; }
    body{ margin:0; font-family:Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); }
    a{ color:#aaa; text-decoration:none; } a:hover{ color:#fff; text-decoration:underline; }
    header{ padding:15px; border-bottom:1px solid var(--border); text-align:center; }
    .site-title{ font-size:24px; font-weight:bold; color:#fff; margin-bottom:5px; }
    .tabs{ display:inline-flex; gap:8px; }
    .tab{ background:transparent; color:#777; border:none; padding:6px 10px; cursor:pointer; }
    .tab[aria-selected="true"]{ color:#fff; }
    .container{ max-width:1200px; margin:15px auto; padding:0 15px; }
    .card{ background:#050505; border:1px solid var(--border); padding:12px; border-radius:8px; }
    .oauth-btn{ background:#5865F2; color:#fff; padding:10px 14px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
    .primary{ background:var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; }
    .secondary{ background:transparent; color:#fff; border:1px solid var(--border); padding:8px 10px; border-radius:6px; cursor:pointer; }
    .muted{ color:#777; font-size:13px; }
    .thumb{ max-width:100%; margin-top:8px; border-radius:6px; border:1px solid var(--border); }
  </style>
</head>
<body>

<header>
  <div class="site-title">Heivoli Network</div>
</header>

<div class="container">

  <div class="card">
    <h2>Connexion Discord</h2>
    <p class="muted">Connecte-toi avec Discord pour uploader.</p>
    <button id="btn-discord" class="oauth-btn">Se connecter avec Discord</button>
    <p id="auth-status" class="muted"></p>
  </div>

  <br>

  <div class="card">
    <h2>Uploader une image</h2>

    <div id="not-auth">
      <p class="muted">Connecte-toi pour uploader.</p>
    </div>

    <div id="upload-area" style="display:none;">
      <input id="file-input" type="file" accept="image/*"><br><br>
      <input id="image-title" type="text" placeholder="Titre (optionnel)"><br><br>
      <button id="btn-upload" class="primary">Uploader</button>
      <button id="btn-logout" class="secondary" style="float:right;">Déconnexion</button>
      <img id="preview" class="thumb" style="display:none">
      <p id="upload-msg" class="muted"></p>
    </div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCbC3pZnkq1ZuthER7BkAoRJPn4SPYGXWE",
  authDomain: "heivoli-network.firebaseapp.com",
  projectId: "heivoli-network",
  storageBucket: "heivoli-network.firebasestorage.app",
  messagingSenderId: "327979808789",
  appId: "1:327979808789:web:067920981030125a82761c"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ================= DISCORD OAUTH ================= */
const FUNCTION_START_URL =
  "https://fr-heivoli-network.cloudfunctions.net/discordAuth/callback";

const TRUSTED_ORIGINS = [
  window.location.origin,
  "https://fr-heivoli-network.cloudfunctions.net"
];

document.getElementById("btn-discord").onclick = () => {
  window.open(
    FUNCTION_START_URL + "?origin=" + encodeURIComponent(window.location.origin),
    "discord",
    "width=500,height=700"
  );
};

window.addEventListener("message", async (e) => {
  if (!TRUSTED_ORIGINS.some(o => e.origin.startsWith(o))) return;

  if (e.data && e.data.firebaseToken) {
    await auth.signInWithCustomToken(e.data.firebaseToken);
  }
});

/* ================= AUTH STATE ================= */
auth.onAuthStateChanged(async (user) => {
  const upload = document.getElementById("upload-area");
  const notAuth = document.getElementById("not-auth");
  const status = document.getElementById("auth-status");

  if (user) {
    upload.style.display = "block";
    notAuth.style.display = "none";

    const ref = db.collection("profiles").doc(user.uid);
    const snap = await ref.get();

    if (!snap.exists) {
      await ref.set({
        uid: user.uid,
        provider: "discord",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    const pseudo =
      user.displayName ||
      (user.providerData[0] && user.providerData[0].displayName) ||
      "DiscordUser";

    status.textContent = "Connecté : " + pseudo;
  } else {
    upload.style.display = "none";
    notAuth.style.display = "block";
    status.textContent = "";
  }
});

/* ================= UPLOAD ================= */
let currentFile = null;

document.getElementById("file-input").onchange = e => {
  currentFile = e.target.files[0];
  if (currentFile) {
    const p = document.getElementById("preview");
    p.src = URL.createObjectURL(currentFile);
    p.style.display = "block";
  }
};

document.getElementById("btn-upload").onclick = async () => {
  const user = auth.currentUser;
  const msg = document.getElementById("upload-msg");
  if (!user || !currentFile) return;

  const path = `uploads/${user.uid}/${Date.now()}`;
  const snap = await storage.ref(path).put(currentFile);
  const url = await snap.ref.getDownloadURL();

  await db.collection("uploads").add({
    uid: user.uid,
    url,
    title: document.getElementById("image-title").value || "",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  msg.textContent = "Upload réussi ✅";
};

document.getElementById("btn-logout").onclick = () => auth.signOut();
</script>

</body>
</html>
